load testdayirrad.mat

% Change stuff here
power_case = case47custom;
numBuses = 47;
pvBus = 45;

opt = mpoption('VERBOSE', 0, 'OUT_ALL', 0); % Verbose = 0 suppresses
% convergence printed output, out_all = 0 suppresses printed results of pf
% analysis

PVcapacity = 30;
storageCap = 20;

storageBus = 13:1:47;
fracinbounds = zeros(1,length(storageBus));
busoutbounds = zeros(1,length(storageBus));

% No storage case
% [noStorage_fracinbounds, noStorage_busoutbounds] = nonviolationfraction(power_case, PVcapacity,...
%         Feb26Irrad, minuteloadFeb2012(36001:37440), opt, storageCap,...
%         storageBus(1), numBuses, pvBus, false, false)

for b = 1:length(storageBus)
    disp('-----------------------------------------------------------');
    tic
    [fracinbounds(b), busoutbounds(b)] = nonviolationfraction(power_case, PVcapacity,...
        Feb26Irrad, minuteloadFeb2012(36001:37440), opt, storageCap,...
        storageBus(b), numBuses, pvBus, true, false); % Feb 26, 2013
    toc
    if b == 1
        noStorage_fracinbounds = fracinbounds(b)
    end
    
    fprintf('Storage bus: %d \n Storage Cap: %d \n Non-Viol Frac: %d \n Num Viol: %d \n',...
        storageBus(b), storageCap, fracinbounds(b), busoutbounds(b));
end

xlim([0,numBuses + 1])
x = 0:0.05:numBuses+1;
y = noStorage_fracinbounds*ones(1,length(x));

disp('Non-violation Fractions:');
disp(fracinbounds)
disp('Number of Violations:');
disp(busoutbounds)
[minViolations, minIdx] = max(fracinbounds);
fprintf('Optimal storage location at bus: %d\n', minIdx);

% Plots
hold on
plot(storageBus(:),fracinbounds(:), 'ro')
plot(x,y,'-b');
xlabel('Location of Storage Bus');
ylabel('Non-Violation Fraction');
hold off;
